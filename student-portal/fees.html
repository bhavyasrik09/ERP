<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College ERP - Fees</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
    }
    .sidebar {
      width: 220px;
      background: #2c3e50;
      color: white;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      padding-top: 20px;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .sidebar a {
      display: block;
      color: white;
      padding: 12px 20px;
      text-decoration: none;
      transition: 0.3s;
    }
    .sidebar a:hover {
      background: #34495e;
    }
    .content {
      margin-left: 220px;
      padding: 20px;
      flex-grow: 1;
    }
    h1 {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    th {
      background: #f4f4f4;
    }
    .back-btn {
      padding: 8px 15px;
      margin-bottom: 15px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .back-btn:hover {
      background: #2980b9;
    }
    .pay-form {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .pay-form input, .pay-form select, .pay-form button {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .receipt {
      margin-top: 20px;
      padding: 15px;
      border: 1px dashed #27ae60;
      background: #ecf9f1;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>ERP Menu</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="fees.html">Fees</a>
    <a href="library.html">Library</a>
    <a href="hostel.html">Hostel</a>
    <a href="exams.html">Exams & Marks</a>
    <a href="attendance.html">Attendance</a>
    <a href="notifications.html">Notifications</a>
    <a href="subjects.html">Subjects</a>
    <a href="index.html">Logout</a>
  </div>

  <!-- Content -->
  <div class="content">
    <button class="back-btn" onclick="window.location.href='dashboard.html'">â¬… Back</button>
    <h1>Fees Details</h1>

    <!-- Fees Table -->
    <table id="feesTable">
      <thead>
        <tr>
          <th>Transaction ID</th>
          <th>Course ID</th>
          <th>Semester</th>
          <th>Amount Paid</th>
          <th>Date</th>
          <th>Mode</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="back-btn" onclick="showPayForm()">ðŸ’³ Pay Fees</button>

    <!-- Payment Form -->
    <div class="pay-form" id="payForm">
      <h3>Pay End Semester Fees</h3>
      <select id="semester">
        <option value="Sem1">Semester 1</option>
        <option value="Sem2">Semester 2</option>
        <option value="Sem3">Semester 3</option>
        <option value="Sem4">Semester 4</option>
        <option value="Sem5">Semester 5</option>
        <option value="Sem6">Semester 6</option>
        <option value="Sem7">Semester 7</option>
        <option value="Sem8">Semester 8</option>
      </select>
      <input type="number" id="amount" placeholder="Enter Amount" required>
      
      <h4>GPay:</h4>
      <p>Scan QR / Enter UPI ID â†’ <b>erp-college@gpay</b></p>
      <input type="file" id="gpayScreenshot" accept="image/*">

      <button onclick="submitFee()">Submit Payment</button>
    </div>

    <!-- Receipt -->
    <div class="receipt" id="receiptBox">
      <h3>Payment Receipt</h3>
      <p><b>Transaction ID:</b> <span id="rTxn"></span></p>
      <p><b>Register No:</b> <span id="rReg"></span></p>
      <p><b>Semester:</b> <span id="rSem"></span></p>
      <p><b>Amount Paid:</b> â‚¹<span id="rAmt"></span></p>
      <p><b>Date:</b> <span id="rDate"></span></p>
      <p><b>Status:</b> Paid âœ…</p>
      <button class="back-btn" onclick="downloadReceipt()">â¬‡ Download PDF</button>
    </div>
  </div>

  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwO4FPtIQl84aDjCnvIz9rERm5frgIO_pR6G16j5BYwFGKHJngSsE2hmv2zhRmY7u1s/exec";

    async function loadFees() {
      const regNo = localStorage.getItem("regNo");
      if(!regNo){ window.location.href = "index.html"; return; }

      const res = await fetch(`${API_URL}?action=fees&regNo=${regNo}`);
      const data = await res.json();
      let html = "";
      data.forEach(f => {
        html += `<tr>
                  <td>${f.TransactionID}</td>
                  <td>${f.CourseID}</td>
                  <td>${f.Semester}</td>
                  <td>â‚¹${f.AmountPaid}</td>
                  <td>${f.PaymentDate}</td>
                  <td>${f.PaymentMode}</td>
                  <td>${f.Status}</td>
                </tr>`;
      });
      document.querySelector("#feesTable tbody").innerHTML = html;
    }

    function showPayForm() {
      document.getElementById("payForm").style.display = "block";
    }

    async function submitFee() {
      const regNo = localStorage.getItem("regNo");
      const semester = document.getElementById("semester").value;
      const amount = document.getElementById("amount").value;

      const res = await fetch(`${API_URL}?action=payFee&regNo=${regNo}&courseID=CSE101&semester=${semester}&amount=${amount}&mode=GPay`);
      const data = await res.json();

      if(data.status === "success") {
        // Show receipt
        document.getElementById("receiptBox").style.display = "block";
        document.getElementById("rTxn").innerText = data.TransactionID;
        document.getElementById("rReg").innerText = regNo;
        document.getElementById("rSem").innerText = semester;
        document.getElementById("rAmt").innerText = amount;
        document.getElementById("rDate").innerText = new Date().toISOString().split("T")[0];

        loadFees(); // Refresh fees table
        document.getElementById("payForm").style.display = "none";
      } else {
        alert("Payment failed!");
      }
    }

    async function downloadReceipt() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const txn = document.getElementById("rTxn").innerText;
      const reg = document.getElementById("rReg").innerText;
      const sem = document.getElementById("rSem").innerText;
      const amt = document.getElementById("rAmt").innerText;
      const date = document.getElementById("rDate").innerText;

      // Title
      doc.setFontSize(18);
      doc.text("College ERP - Payment Receipt", 20, 20);

      // Receipt details
      doc.setFontSize(12);
      doc.text(`Transaction ID : ${txn}`, 20, 40);
      doc.text(`Register No    : ${reg}`, 20, 50);
      doc.text(`Semester       : ${sem}`, 20, 60);
      doc.text(`Amount Paid    : â‚¹${amt}`, 20, 70);
      doc.text(`Date           : ${date}`, 20, 80);
      doc.text("Status         : Paid âœ…", 20, 90);

      // Footer
      doc.setFontSize(10);
      doc.text("This is a system generated receipt.", 20, 110);

      // Save PDF
      doc.save(`receipt_${txn}.pdf`);
    }

    document.addEventListener("DOMContentLoaded", loadFees);
  </script>
</body>
</html>
